---
title: Configuration Stripe
icon: "CreditCard"
---

## Aperçu

Le template utilise Stripe Checkout pour les paiements et un registre de crédits pour accorder du solde après l’achat.

- UI : `/[locale]/pricing` lit les plans depuis un fichier TypeScript typé.
- Création de session : le client envoie `POST /api/checkout` puis est redirigé vers Stripe.
- Retour : Stripe renvoie l’utilisateur vers `/api/pay/callback/stripe` (GET).
- Finalisation serveur : Stripe envoie un webhook sur `/api/pay/webhook/stripe` (POST) qui marque la commande payée et crédite le compte.

Le webhook est la source de vérité ; le callback ne fait que rediriger.

---

## Endpoints

- `/api/checkout` (POST) : valide le plan (`src/data/pricing.ts`), crée la session, enregistre une `order` `created`.
- `/api/pay/callback/stripe` (GET) : redirection post‑Stripe ; ne finalise plus la commande.
- `/api/pay/webhook/stripe` (POST) : vérifie la signature et traite `checkout.session.completed` pour marquer `paid` et créditer.

---

## Crédits

1) Récupération de `order_no` depuis les métadonnées de la session.
2) Mise à jour de la commande en `paid` + détails de paiement.
3) Ajout d’une ligne positive dans `credits` (`order_pay`).

---

## Pré-requis

```bash
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_WEB_URL=http://localhost:3000
NEXT_PUBLIC_PAY_CANCEL_URL=/pricing
NEXT_PUBLIC_PAY_SUCCESS_URL=/pricing
NEXT_PUBLIC_PAY_FAIL_URL=/pricing
```

---

## Webhook local

```bash
stripe login
stripe listen --forward-to localhost:3000/api/pay/webhook/stripe
stripe trigger checkout_session_completed
```

---

## Essayer

1) Créez un compte et connectez‑vous.
2) Ouvrez `/[locale]/pricing` et choisissez un plan.
3) Carte de test : `4242 4242 4242 4242`.
4) Redirection vers le callback ; le webhook confirme et crédite.
5) Vérifiez `/[locale]/credits-test` ou `POST /api/account/credits`.

---

## Détails d’implémentation

- Plans : `src/data/pricing.ts`.
- `handleCheckoutSession` gère paiement unique et abonnement (PaymentIntent via `latest_invoice`).
- Ajoutez `invoice.payment_succeeded` si nécessaire pour les renouvellements.

---

## Facturation et Abonnements

### Portail Client

Activez le Customer Portal de Stripe et choisissez ce que vos clients peuvent gérer (annuler/reprendre, mettre à jour la carte, consulter les factures).

Dans ce template :

- API : `GET /api/billing/portal` — crée une session du portail et redirige vers Stripe
- UI : `/:locale/account/billing` — bouton « Manage billing » qui ouvre le portail

Implémentation :

- Route API : `src/app/api/billing/portal/route.ts`
  - Recherche ou crée un Customer Stripe via l’email de l’utilisateur connecté
  - Crée une session de portail avec `return_url` vers `/:locale/account/billing`

Côté interface (Server Component) :

- `src/app/[locale]/account/billing/page.tsx` pointe vers `/api/billing/portal?locale=<locale>`

### Relance (Paiements échoués)

Webhook : `invoice.payment_failed` déclenche un email demandant la mise à jour du moyen de paiement (via Resend).

- Template : `src/services/email/templates/payment-failed.tsx`
- Envoi : `sendPaymentFailedEmail()` dans `src/services/email/send.ts`
- Webhook : voir `src/app/api/pay/webhook/stripe/route.ts`

Test local avec Stripe CLI :

```bash
stripe trigger invoice_payment_failed
```

Remarque : l’email inclut un lien vers `/:locale/account/billing` pour ouvrir le portail depuis l’app.
